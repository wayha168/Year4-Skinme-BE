<div th:fragment="sidebar" class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="d-flex justify-content-center align-items-center">
      <h2 class="sidebar-title"><i class="bi bi-flower1"></i> <span class="sidebar-title-text">SkinMe</span></h2>
    </div>
  </div>

  <ul class="nav sidebar-nav" id="sidebar-nav">
    <li class="nav-item">
      <a th:href="@{/dashboard}" class="nav-link" data-tooltip="Dashboard"> 
        <i class="bi bi-speedometer2"></i> 
        <span class="nav-link-text">Dashboard</span>
      </a>
    </li>

    <li class="nav-separator"></li>

    <li class="nav-item">
      <a
        class="nav-link dropdown-toggle"
        data-bs-toggle="collapse"
        href="#stockMenu"
        role="button"
        aria-expanded="false"
        aria-controls="stockMenu"
        data-tooltip="Stock Management"
      >
        <i class="bi bi-box-seam"></i> 
        <span class="nav-link-text">Stock Management</span>
      </a>
      <div class="collapse" id="stockMenu" data-bs-parent="#sidebar-nav">
        <a th:href="@{/views/categories}" class="nav-link sub-nav-link" data-tooltip="Categories"> 
          <i class="bi bi-tags"></i> 
          <span class="nav-link-text">Categories</span> 
        </a>
        <a th:href="@{/views/products}" class="nav-link sub-nav-link" data-tooltip="Products"> 
          <i class="bi bi-box"></i> 
          <span class="nav-link-text">Products</span> 
        </a>
        <a th:href="@{/views/promotions}" class="nav-link sub-nav-link" sec:authorize="hasRole('ADMIN')" data-tooltip="Promotions"> 
          <i class="bi bi-tag"></i> 
          <span class="nav-link-text">Promotions</span> 
        </a>
      </div>
    </li>

    <li class="nav-separator"></li>

    <li class="nav-item">
      <a
        class="nav-link dropdown-toggle"
        data-bs-toggle="collapse"
        href="#saleMenu"
        role="button"
        aria-expanded="false"
        aria-controls="saleMenu"
        data-tooltip="Sales Management"
      >
        <i class="bi bi-cash-coin"></i> 
        <span class="nav-link-text">Sales Management</span>
      </a>
      <div class="collapse" id="saleMenu" data-bs-parent="#sidebar-nav">
        <a th:href="@{/views/orders}" class="nav-link sub-nav-link" data-tooltip="Orders Record"> 
          <i class="bi bi-bag-check"></i> 
          <span class="nav-link-text">Orders Record</span> 
        </a>
        <a th:href="@{/views/payments}" class="nav-link sub-nav-link" data-tooltip="Payment Record"> 
          <i class="bi bi-receipt"></i> 
          <span class="nav-link-text">Payment Record</span> 
        </a>
        <a th:href="@{/views/delivery}" class="nav-link sub-nav-link" data-tooltip="Delivery Record"> 
          <i class="bi bi-truck"></i> 
          <span class="nav-link-text">Delivery Record</span> 
        </a>
      </div>
    </li>

    <li class="nav-separator"></li>

    <li class="nav-item">
      <a th:href="@{/views/chat}" class="nav-link" data-tooltip="Chat"> 
        <i class="bi bi-chat-dots"></i> 
        <span class="nav-link-text">Chat</span>
      </a>
    </li>

    <li class="nav-separator"></li>

    <li class="nav-item">
      <a
        class="nav-link dropdown-toggle"
        data-bs-toggle="collapse"
        href="#userMenu"
        role="button"
        aria-expanded="false"
        aria-controls="userMenu"
        data-tooltip="User Menu"
      >
        <i class="bi bi-person-circle"></i> 
        <span class="nav-link-text">User Menu</span>
      </a>
      <div class="collapse" id="userMenu" data-bs-parent="#sidebar-nav">
        <a th:href="@{/views/my-orders}" class="nav-link sub-nav-link" data-tooltip="My Orders"> 
          <i class="bi bi-bag"></i> 
          <span class="nav-link-text">My Orders</span> 
        </a>
        <a th:href="@{/views/my-payments}" class="nav-link sub-nav-link" data-tooltip="My Payments"> 
          <i class="bi bi-wallet2"></i> 
          <span class="nav-link-text">My Payments</span> 
        </a>
        <a th:href="@{/views/users}" class="nav-link sub-nav-link" sec:authorize="hasRole('ADMIN')" data-tooltip="User Management"> 
          <i class="bi bi-people"></i> 
          <span class="nav-link-text">User Management</span> 
        </a>
        <a th:href="@{/views/audit-logs}" class="nav-link sub-nav-link" sec:authorize="hasRole('ADMIN')" data-tooltip="Audit Log"> 
          <i class="bi bi-clipboard-data"></i> 
          <span class="nav-link-text">Audit Log</span> 
        </a>
      </div>
    </li>
  </ul>

  <div class="sidebar-footer">
    <a
      href="#"
      class="nav-link"
      data-tooltip="Logout"
      onclick="handleLogout(event);"
    >
      <i class="bi bi-box-arrow-right"></i> <span class="nav-link-text">Logout</span>
    </a>
  </div>
</div>


<script>
  // Ensure only one dropdown menu is open at a time
  (function() {
    function initSidebarDropdowns() {
      const sidebarNav = document.getElementById('sidebar-nav');
      if (!sidebarNav) return;

      const collapseElements = sidebarNav.querySelectorAll('.collapse');
      const toggleLinks = sidebarNav.querySelectorAll('[data-bs-toggle="collapse"]');

      // Function to close all collapses except the target
      function closeOtherCollapses(targetCollapse) {
        collapseElements.forEach(function(collapse) {
          if (collapse !== targetCollapse && collapse.classList.contains('show')) {
            // Try to use Bootstrap Collapse API if available
            if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
              const bsCollapse = bootstrap.Collapse.getInstance(collapse);
              if (bsCollapse) {
                bsCollapse.hide();
                return;
              }
            }
            // Fallback: manually hide
            collapse.classList.remove('show');
            const otherToggle = sidebarNav.querySelector('[href="#' + collapse.id + '"]');
            if (otherToggle) {
              otherToggle.setAttribute('aria-expanded', 'false');
            }
          }
        });
      }

      toggleLinks.forEach(function(toggleLink) {
        toggleLink.addEventListener('click', function(e) {
          const targetId = this.getAttribute('href');
          const targetCollapse = document.querySelector(targetId);
          
          if (!targetCollapse) return;

          // If clicking on an already open menu, close it
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          
          if (!isExpanded) {
            // Close all other collapses before opening this one
            closeOtherCollapses(targetCollapse);
          }
        });
      });

      // Update aria-expanded when collapse events fire (if Bootstrap is available)
      if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {
        collapseElements.forEach(function(collapse) {
          collapse.addEventListener('show.bs.collapse', function() {
            const toggle = sidebarNav.querySelector('[href="#' + this.id + '"]');
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'true');
            }
          });

          collapse.addEventListener('hide.bs.collapse', function() {
            const toggle = sidebarNav.querySelector('[href="#' + this.id + '"]');
            if (toggle) {
              toggle.setAttribute('aria-expanded', 'false');
            }
          });
        });
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebarDropdowns);
    } else {
      initSidebarDropdowns();
    }
  })();
</script>
