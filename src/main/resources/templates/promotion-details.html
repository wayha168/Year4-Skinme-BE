<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/details.css" />
      <link rel="stylesheet" href="/css/badges.css" />
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle != null ? pageTitle : 'Promotion Details'}">Promotion Details</title>
  </head>
  <body>
    <th:block th:fragment="main">
    <main class="main-content">
      <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-tag'"></div>
      <div class="container-fluid px-4 mb-2">
        <a th:href="@{/views/promotions}" class="btn btn-light btn-sm"><i class="bi bi-arrow-left"></i> Back to Promotions</a>
      </div>

      <div class="container-fluid px-4 mb-5" th:if="${promotion}">
        <div class="row">
          <div class="col-lg-8">
            <div class="card detail-card">
              <div class="card-body p-4">
                <h3 class="mb-3" th:text="${promotion.title}">Promotion Title</h3>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-hash"></i> ID</span>
                  <span class="info-value" th:text="${promotion.id}">1</span>
                </div>
                <div class="info-row" th:if="${promotion.productName}">
                  <span class="info-label"><i class="bi bi-box"></i> Product</span>
                  <span class="info-value" th:text="${promotion.productName + ' (ID: ' + promotion.productId + ')'}">Product</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-percent"></i> Discount</span>
                  <span class="info-value table-tag table-tag-green" th:text="${promotion.discountPercentage != null ? #numbers.formatDecimal(promotion.discountPercentage, 1, 2) + '%' : 'N/A'}">0%</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-currency-dollar"></i> Original Price</span>
                  <span class="info-value text-muted" style="text-decoration: line-through;" th:text="'$' + ${#numbers.formatDecimal(promotion.originalPrice != null ? promotion.originalPrice : 0, 1, 2)}">$0.00</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-currency-dollar"></i> Discounted Price</span>
                  <span class="info-value fw-bold text-success" th:text="'$' + ${#numbers.formatDecimal(promotion.discountedPrice != null ? promotion.discountedPrice : 0, 1, 2)}">$0.00</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-calendar-check"></i> Start Date</span>
                  <span class="info-value" th:text="${promotion.startDate != null ? #temporals.format(promotion.startDate, 'MM/dd/yyyy HH:mm') : 'N/A'}">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-calendar-x"></i> Deadline</span>
                  <span class="info-value" th:text="${promotion.deadline != null ? #temporals.format(promotion.deadline, 'MM/dd/yyyy HH:mm') : 'N/A'}">-</span>
                  <span th:if="${promotion.deadline != null and promotion.deadline.isBefore(T(java.time.LocalDateTime).now())}" class="ms-2 table-tag table-tag-expired">Expired</span>
                  <span th:if="${promotion.currentlyActive}" class="ms-2 table-tag table-tag-active">Active Now</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-toggles"></i> Status</span>
                  <span th:if="${promotion.active}" class="info-value status-badge-active"><i class="bi bi-check-circle-fill"></i> Active</span>
                  <span th:unless="${promotion.active}" class="info-value status-badge-inactive">Inactive</span>
                </div>
                <div class="info-row" th:if="${promotion.link}">
                  <span class="info-label"><i class="bi bi-link"></i> Link</span>
                  <a th:href="${promotion.link}" target="_blank" class="info-value" th:text="${promotion.link}">Link</a>
                </div>
                <div class="mt-4" th:if="${promotion.description}">
                  <h5>Description</h5>
                  <p th:text="${promotion.description}" class="text-muted">Description</p>
                </div>
                <div class="mt-3">
                  <a th:href="@{/views/promotions/create(id=${promotion.id})}" class="btn btn-primary"><i class="bi bi-pencil"></i> Edit</a>
                  <button type="button" class="btn btn-outline-danger ms-2" id="btnDeletePromotion" th:data-id="${promotion.id}"><i class="bi bi-trash"></i> Delete</button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4" th:if="${promotion.images != null and !promotion.images.isEmpty()}">
            <div class="card detail-card">
              <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                <h5 class="mb-0"><i class="bi bi-image"></i> Images</h5>
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                  <img th:each="image : ${promotion.images}"
                       th:src="${image.downloadUrl}"
                       th:alt="${image.fileName}"
                       style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6; cursor: pointer;"
                       th:attr="onclick=|window.open('${image.downloadUrl}', '_blank')|"
                       onerror="this.style.display='none'" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid px-4 mb-5" th:unless="${promotion}">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i> <span th:text="${error != null ? error : 'Promotion not found'}">Promotion not found</span>
        </div>
      </div>
    </main>
    </th:block>

    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
          var btn = document.getElementById('btnDeletePromotion');
          if (btn) {
            btn.addEventListener('click', function() {
              if (!confirm('Are you sure you want to delete this promotion? This cannot be undone.')) return;
              var id = btn.getAttribute('data-id');
              var csrfToken = document.querySelector('meta[name="_csrf"]');
              var csrfHeader = document.querySelector('meta[name="_csrf_header"]');
              var headers = { 'Content-Type': 'application/json' };
              if (csrfToken && csrfHeader) {
                headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content') || csrfToken.content;
              }
              fetch('/api/v1/promotions/' + id, { method: 'DELETE', headers: headers })
                .then(function(r) { return r.json(); })
                .then(function(result) {
                  if (typeof showToast === 'function') showToast(result.message || 'Deleted', 'success');
                  setTimeout(function() { window.location.href = '/views/promotions'; }, 1000);
                })
                .catch(function(err) {
                  if (typeof showToast === 'function') showToast('Delete failed: ' + err.message, 'error');
                });
            });
          }
        });
      </script>
    </th:block>
  </body>
</html>
