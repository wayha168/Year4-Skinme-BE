<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/forms.css" />
      <style>
        .promotion-form {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
        }
        .discount-preview {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 15px;
          border-radius: 8px;
          margin-top: 15px;
        }
        .discount-preview h6 {
          margin: 0;
          color: white;
        }
        .discount-preview .price-comparison {
          display: flex;
          justify-content: space-between;
          margin-top: 10px;
        }
        .price-original {
          text-decoration: line-through;
          opacity: 0.8;
        }
        .price-discounted {
          font-size: 1.3rem;
          font-weight: bold;
        }
        .image-preview-item {
          position: relative;
          width: 120px;
          height: 120px;
          border: 2px solid #ddd;
          border-radius: 8px;
          overflow: hidden;
          display: inline-block;
          margin-right: 10px;
          margin-bottom: 10px;
        }
        .image-preview-item img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        .image-preview-item .remove-image {
          position: absolute;
          top: 5px;
          right: 5px;
          background: rgba(220, 53, 69, 0.8);
          color: white;
          border: none;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 14px;
        }
        .image-preview-item .remove-image:hover {
          background: rgba(220, 53, 69, 1);
        }
      </style>
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle ?: 'Create Promotion'}">Create Promotion</title>
  </head>
  <body>
    <th:block th:fragment="main">
      <div class="main-content">
        <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-tag', pageTitle=${pageTitle ?: 'Create Promotion'}"></div>

        <div class="container-fluid px-4">
          <!-- Create/Edit Promotion Form -->
          <div class="card mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
              <h5 class="mb-0">
                <i class="bi" th:classappend="${editingId != null} ? 'bi-pencil' : 'bi-plus-circle'"></i> 
                <span id="form-title" th:text="${editingId != null} ? 'Edit Promotion' : 'Create New Promotion'">Create New Promotion</span>
              </h5>
            </div>
            <div class="card-body">
              <form id="promotion-form" class="promotion-form">
                <input type="hidden" id="promotion-id" th:value="${editingId}" />
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="title" class="form-label">Title *</label>
                    <input type="text" class="form-control" id="title" required maxlength="200" placeholder="Promotion title" 
                           th:value="${promotion?.title}" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="product-select" class="form-label">Product *</label>
                    <select class="form-select" id="product-select" required>
                      <option value="">Select a product</option>
                      <option th:each="product : ${products}" 
                              th:value="${product.id}" 
                              th:text="${product.name + ' - $' + #numbers.formatDecimal(product.price, 1, 2)}"
                              th:selected="${promotion != null and promotion.productId == product.id}"></option>
                    </select>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" rows="3" placeholder="Promotion description" 
                            th:text="${promotion?.description}"></textarea>
                </div>

                <div class="row">
                  <div class="col-md-3 mb-3">
                    <label for="discount-percentage" class="form-label">Discount Percentage (%) *</label>
                    <input type="number" class="form-control" id="discount-percentage" required 
                           min="0.01" max="100" step="0.01" placeholder="0.00"
                           th:value="${promotion?.discountPercentage}" />
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="start-date" class="form-label">Start Date (Use Date) *</label>
                    <input type="datetime-local" class="form-control" id="start-date" required />
                    <small class="form-text text-muted">Auto-set to now when creating</small>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="duration-days" class="form-label">Duration (Days) *</label>
                    <input type="number" class="form-control" id="duration-days" 
                           min="1" max="365" step="1" placeholder="7" value="7" />
                    <small class="form-text text-muted">Auto-calculates deadline</small>
                  </div>
                  <div class="col-md-3 mb-3">
                    <label for="deadline" class="form-label">Deadline Date *</label>
                    <input type="datetime-local" class="form-control" id="deadline" required />
                    <small class="form-text text-muted">Auto-calculated from duration</small>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="link" class="form-label">Link</label>
                  <input type="url" class="form-control" id="link" placeholder="https://example.com/promotion"
                         th:value="${promotion?.link}" />
                </div>

                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="active" 
                           th:checked="${promotion == null or promotion.active}" />
                    <label class="form-check-label" for="active">Active</label>
                  </div>
                </div>

                <!-- Image Upload -->
                <div class="mb-3">
                  <label for="promotion-images" class="form-label">Promotion Images</label>
                  <input type="file" class="form-control" id="promotion-images" multiple accept="image/*" />
                  <small class="form-text text-muted">You can select one or multiple images for this promotion</small>
                  <div id="image-preview-container" class="mt-3" style="display: none;">
                    <div class="d-flex flex-wrap gap-2" id="image-preview-list"></div>
                  </div>
                </div>

                <!-- Discount Preview -->
                <div id="discount-preview" class="discount-preview" style="display: none;">
                  <h6><i class="bi bi-calculator"></i> Price Preview</h6>
                  <div class="price-comparison">
                    <div>
                      <small>Original Price:</small>
                      <div class="price-original" id="original-price">$0.00</div>
                    </div>
                    <div>
                      <small>Discounted Price:</small>
                      <div class="price-discounted" id="discounted-price">$0.00</div>
                    </div>
                    <div>
                      <small>You Save:</small>
                      <div class="price-discounted" id="savings">$0.00</div>
                    </div>
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> <span id="submit-text" th:text="${editingId != null} ? 'Update Promotion' : 'Create Promotion'">Create Promotion</span>
                  </button>
                  <a href="/views/promotions" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </th:block>

    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
        const API_PREFIX = /*[[${api.prefix}]]*/ '/api/v1';
        let productsData = /*[[${products}]]*/ [];
        let editingPromotionId = /*[[${editingId}]]*/ null;
        let selectedImages = [];

        // Initialize form if editing
        document.addEventListener('DOMContentLoaded', function() {
          const promotion = /*[[${promotion}]]*/ null;
          if (promotion && editingPromotionId) {
            // Format dates for datetime-local input
            if (promotion.startDate) {
              const startDate = new Date(promotion.startDate);
              document.getElementById('start-date').value = formatDateTimeLocal(startDate);
            }
            if (promotion.deadline) {
              const deadline = new Date(promotion.deadline);
              document.getElementById('deadline').value = formatDateTimeLocal(deadline);
              
              // Calculate duration from start date and deadline
              if (promotion.startDate) {
                const start = new Date(promotion.startDate);
                const end = new Date(promotion.deadline);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById('duration-days').value = diffDays;
              }
            }
            updateDiscountPreview();
          } else {
            // Auto-set start date to now when creating
            autoSetStartDate();
          }
        });

        // Image handling
        document.getElementById('promotion-images').addEventListener('change', function(e) {
          selectedImages = Array.from(e.target.files);
          displayImagePreviews();
        });

        function displayImagePreviews() {
          const container = document.getElementById('image-preview-container');
          const list = document.getElementById('image-preview-list');
          
          if (selectedImages.length === 0) {
            container.style.display = 'none';
            return;
          }
          
          container.style.display = 'block';
          list.innerHTML = '';
          
          selectedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
              const div = document.createElement('div');
              div.className = 'image-preview-item';
              div.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}" />
                <button type="button" class="remove-image" onclick="removeImage(${index})">
                  <i class="bi bi-x"></i>
                </button>
              `;
              list.appendChild(div);
            };
            reader.readAsDataURL(file);
          });
        }

        function removeImage(index) {
          selectedImages.splice(index, 1);
          const input = document.getElementById('promotion-images');
          const dt = new DataTransfer();
          selectedImages.forEach(file => dt.items.add(file));
          input.files = dt.files;
          displayImagePreviews();
        }

        async function uploadPromotionImages(promotionId) {
          if (selectedImages.length === 0) {
            return;
          }

          const formData = new FormData();
          selectedImages.forEach(file => {
            formData.append('files', file);
          });

          try {
            const response = await fetch(`${API_PREFIX}/promotions/${promotionId}/images`, {
              method: 'POST',
              body: formData
            });

            const result = await response.json();
            if (!response.ok) {
              console.error('Failed to upload images:', result.message);
              if (typeof showToast === 'function') {
                showToast('Failed to upload images: ' + (result.message || 'Unknown error'), 'error');
              }
            }
          } catch (error) {
            console.error('Error uploading images:', error);
            if (typeof showToast === 'function') {
              showToast('Error uploading images: ' + error.message, 'error');
            }
          }
        }

        // Auto-calculate deadline from duration
        function calculateDeadline() {
          const startDateInput = document.getElementById('start-date');
          const durationInput = document.getElementById('duration-days');
          const deadlineInput = document.getElementById('deadline');
          
          if (startDateInput.value && durationInput.value) {
            const startDate = new Date(startDateInput.value);
            const durationDays = parseInt(durationInput.value) || 7;
            const deadline = new Date(startDate);
            deadline.setDate(deadline.getDate() + durationDays);
            deadlineInput.value = formatDateTimeLocal(deadline);
          }
        }

        // Auto-set start date to now when creating
        function autoSetStartDate() {
          if (!editingPromotionId) {
            const now = new Date();
            const startDateInput = document.getElementById('start-date');
            startDateInput.value = formatDateTimeLocal(now);
            calculateDeadline();
          }
        }

        // Format date for datetime-local input
        function formatDateTimeLocal(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Update discount preview
        function updateDiscountPreview() {
          const productId = document.getElementById('product-select').value;
          const discountPercentage = parseFloat(document.getElementById('discount-percentage').value) || 0;
          
          if (productId && discountPercentage > 0) {
            const product = productsData.find(p => p.id == productId);
            if (product && product.price) {
              const originalPrice = parseFloat(product.price);
              const discountAmount = originalPrice * (discountPercentage / 100);
              const discountedPrice = originalPrice - discountAmount;
              
              document.getElementById('original-price').textContent = '$' + originalPrice.toFixed(2);
              document.getElementById('discounted-price').textContent = '$' + discountedPrice.toFixed(2);
              document.getElementById('savings').textContent = '$' + discountAmount.toFixed(2);
              document.getElementById('discount-preview').style.display = 'block';
            }
          } else {
            document.getElementById('discount-preview').style.display = 'none';
          }
        }

        // Form submission
        document.getElementById('promotion-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (typeof showToast === 'function') {
            showToast(editingPromotionId ? 'Updating promotion...' : 'Creating promotion...', 'info');
          }
          
          const formData = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            link: document.getElementById('link').value,
            discountPercentage: parseFloat(document.getElementById('discount-percentage').value),
            startDate: document.getElementById('start-date').value,
            deadline: document.getElementById('deadline').value,
            productId: parseInt(document.getElementById('product-select').value),
            active: document.getElementById('active').checked
          };
          
          // Convert datetime-local to ISO format
          if (formData.startDate) {
            formData.startDate = new Date(formData.startDate).toISOString();
          }
          if (formData.deadline) {
            formData.deadline = new Date(formData.deadline).toISOString();
          }
          
          try {
            const url = editingPromotionId 
              ? `${API_PREFIX}/promotions/${editingPromotionId}`
              : `${API_PREFIX}/promotions/create`;
            const method = editingPromotionId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
              method: method,
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
              const promotionId = result.data?.id || editingPromotionId;
              if (promotionId && selectedImages.length > 0) {
                // Upload images after promotion is created/updated
                await uploadPromotionImages(promotionId);
              }
              if (typeof showToast === 'function') {
                showToast(result.message || (editingPromotionId ? 'Promotion updated successfully' : 'Promotion created successfully'), 'success');
              }
              setTimeout(() => {
                window.location.href = '/views/promotions';
              }, 1000);
            } else {
              if (typeof showToast === 'function') {
                showToast('Failed to save promotion: ' + (result.message || 'Unknown error'), 'error');
              }
            }
          } catch (error) {
            console.error('Error saving promotion:', error);
            if (typeof showToast === 'function') {
              showToast('Error saving promotion: ' + error.message, 'error');
            }
          }
        });

        // Update preview on change
        document.getElementById('product-select').addEventListener('change', updateDiscountPreview);
        document.getElementById('discount-percentage').addEventListener('input', updateDiscountPreview);
        
        // Auto-calculate deadline when start date or duration changes
        document.getElementById('start-date').addEventListener('change', calculateDeadline);
        document.getElementById('duration-days').addEventListener('input', calculateDeadline);
        document.getElementById('duration-days').addEventListener('change', calculateDeadline);

        // Set minimum date to today
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('start-date').min = now.toISOString().slice(0, 16);
        document.getElementById('deadline').min = now.toISOString().slice(0, 16);
      </script>
    </th:block>
  </body>
</html>
