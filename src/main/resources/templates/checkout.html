<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <style>
        .checkout-container {
          max-width: 800px;
          margin: 0 auto;
        }
        .card-element {
          padding: 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background: white;
          margin-bottom: 20px;
        }
        .card-element:focus {
          border-color: #0066cc;
          outline: none;
        }
        .StripeElement {
          height: 40px;
        }
        #card-errors {
          color: #dc3545;
          margin-top: 10px;
          font-size: 0.875rem;
        }
        .payment-form, .delivery-form {
          background: #f8f9fa;
          padding: 30px;
          border-radius: 8px;
          margin-bottom: 20px;
        }
        .order-summary {
          background: white;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
        }
        #map {
          height: 300px;
          width: 100%;
          border-radius: 8px;
          margin-bottom: 15px;
        }
        .payment-method-option {
          border: 2px solid #ddd;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 15px;
          cursor: pointer;
          transition: all 0.3s;
        }
        .payment-method-option:hover {
          border-color: #0066cc;
          background-color: #f0f7ff;
        }
        .payment-method-option.selected {
          border-color: #0066cc;
          background-color: #e6f2ff;
        }
        .payment-method-option input[type="radio"] {
          margin-right: 10px;
        }
        .khqr-qr-container {
          text-align: center;
          padding: 20px;
          background: white;
          border-radius: 8px;
          margin-top: 20px;
        }
        .khqr-qr-container img {
          max-width: 300px;
          border: 1px solid #ddd;
          border-radius: 8px;
        }
        .address-input-group {
          margin-bottom: 15px;
        }
        .btn-use-map {
          margin-top: 10px;
        }
      </style>
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRJqXz8CRx4N-llC2R20-buyliki5dNM8&libraries=places"></script>
  </head>
  <body>
    <th:block th:fragment="main">
      <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-credit-card', pageTitle='Checkout'"></div>
      
      <div class="container-fluid px-4 mb-5">
        <div class="checkout-container">
          <div class="order-summary" th:if="${order}">
            <h5 class="mb-3"><i class="bi bi-receipt"></i> Order Summary</h5>
            <div class="d-flex justify-content-between mb-2">
              <span>Order ID:</span>
              <strong th:text="'#' + ${order.orderId}">#12345</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Total Amount:</span>
              <strong style="color: #0066cc; font-size: 1.2rem;" 
                     th:text="'$' + ${#numbers.formatDecimal(order.orderTotalAmount, 1, 2)}">$0.00</strong>
            </div>
          </div>

          <!-- Delivery Address Section -->
          <div class="delivery-form">
            <h5 class="mb-4"><i class="bi bi-geo-alt"></i> Delivery Address</h5>
            
            <div class="mb-3">
              <label for="address-search" class="form-label">Search Address on Map</label>
              <input type="text" id="address-search" class="form-control" placeholder="Search for an address..." />
              <button type="button" class="btn btn-outline-primary btn-sm btn-use-map" onclick="useMapLocation()">
                <i class="bi bi-geo-alt-fill"></i> Use Map Location
              </button>
            </div>

            <div id="map"></div>

            <form id="delivery-address-form">
              <div class="row">
                <div class="col-md-12 address-input-group">
                  <label for="delivery-address-full" class="form-label">Full Address *</label>
                  <input type="text" id="delivery-address-full" class="form-control" 
                         placeholder="Street address, building, floor, etc." required />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 address-input-group">
                  <label for="delivery-city" class="form-label">City *</label>
                  <input type="text" id="delivery-city" class="form-control" placeholder="City" required />
                </div>
                <div class="col-md-6 address-input-group">
                  <label for="delivery-province" class="form-label">Province *</label>
                  <input type="text" id="delivery-province" class="form-control" placeholder="Province" required />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 address-input-group">
                  <label for="delivery-postal-code" class="form-label">Postal Code</label>
                  <input type="text" id="delivery-postal-code" class="form-control" placeholder="Postal Code" />
                </div>
                <div class="col-md-6 address-input-group">
                  <label class="form-label">Coordinates</label>
                  <input type="text" id="coordinates-display" class="form-control" readonly 
                         placeholder="Latitude, Longitude" />
                  <input type="hidden" id="delivery-latitude" />
                  <input type="hidden" id="delivery-longitude" />
                </div>
              </div>
            </form>
          </div>

          <!-- Payment Method Selection -->
          <div class="payment-form">
            <h5 class="mb-4"><i class="bi bi-credit-card-2-front"></i> Payment Method</h5>
            
            <div class="payment-method-option" onclick="selectPaymentMethod('stripe')">
              <input type="radio" name="payment-method" id="payment-stripe" value="stripe" checked />
              <label for="payment-stripe" style="cursor: pointer;">
                <strong><i class="bi bi-credit-card"></i> Credit/Debit Card (Stripe)</strong>
                <p class="text-muted mb-0" style="font-size: 0.9rem;">Pay securely with your card</p>
              </label>
            </div>

            <div class="payment-method-option" onclick="selectPaymentMethod('khqr')">
              <input type="radio" name="payment-method" id="payment-khqr" value="khqr" />
              <label for="payment-khqr" style="cursor: pointer;">
                <strong><i class="bi bi-qr-code"></i> KHQR Payment</strong>
                <p class="text-muted mb-0" style="font-size: 0.9rem;">Scan QR code with your mobile banking app</p>
              </label>
            </div>

            <!-- Stripe Payment Form -->
            <div id="stripe-payment-section">
              <form id="payment-form" th:if="${order}">
                <input type="hidden" id="order-id" th:value="${order.id}" />
                <input type="hidden" id="amount-cents" th:value="${order.orderTotalAmount * 100}" />
                
                <div class="mb-3">
                  <label for="card-element" class="form-label">Card Information</label>
                  <div id="card-element" class="card-element">
                    <!-- Stripe Elements will create form elements here -->
                  </div>
                  <div id="card-errors" role="alert"></div>
                </div>

                <div class="mb-3">
                  <label for="cardholder-name" class="form-label">Cardholder Name</label>
                  <input type="text" id="cardholder-name" class="form-control" placeholder="John Doe" required />
                </div>

                <button type="submit" id="submit-button" class="btn btn-primary w-100" style="height: 50px;">
                  <span id="button-text">
                    <i class="bi bi-lock-fill"></i> Pay 
                    <span th:text="'$' + ${#numbers.formatDecimal(order.orderTotalAmount, 1, 2)}">$0.00</span>
                  </span>
                  <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
              </form>
            </div>

            <!-- KHQR Payment Section -->
            <div id="khqr-payment-section" style="display: none;">
              <div class="khqr-qr-container">
                <h6 class="mb-3">Scan QR Code to Pay</h6>
                <div id="khqr-qr-image-container">
                  <p class="text-muted">Loading QR code...</p>
                </div>
                <p class="mt-3 text-muted" style="font-size: 0.9rem;">
                  Scan this QR code with your mobile banking app (ABA, ACLEDA, etc.) to complete payment
                </p>
                <div class="mt-3">
                  <button type="button" id="verify-khqr-payment" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> I've Completed Payment
                  </button>
                </div>
              </div>
            </div>

            <div th:if="${error}" class="alert alert-danger mt-3">
              <i class="bi bi-exclamation-circle"></i> <span th:text="${error}"></span>
            </div>
          </div>
        </div>
      </div>
    </th:block>
    
    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
        // Google Maps API key
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBRJqXz8CRx4N-llC2R20-buyliki5dNM8';
        
        // Initialize Stripe
        const stripe = Stripe(/*[[${stripePublicKey}]]*/ 'pk_test_...');
        const elements = stripe.elements();
        
        // Google Maps variables
        let map;
        let marker;
        let geocoder;
        let autocomplete;
        let selectedLocation = null;

        // Initialize Google Maps
        function initMap() {
          // Default location: Phnom Penh, Cambodia
          const defaultLocation = { lat: 11.5564, lng: 104.9282 };
          
          map = new google.maps.Map(document.getElementById('map'), {
            center: defaultLocation,
            zoom: 13,
            mapTypeControl: true,
            streetViewControl: true
          });

          geocoder = new google.maps.Geocoder();
          
          // Create marker
          marker = new google.maps.Marker({
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP
          });

          // Set initial marker position
          marker.setPosition(defaultLocation);
          updateAddressFromLocation(defaultLocation);

          // Click on map to set location
          map.addListener('click', function(event) {
            const location = event.latLng;
            marker.setPosition(location);
            updateAddressFromLocation(location);
          });

          // Drag marker to update location
          marker.addListener('dragend', function() {
            updateAddressFromLocation(marker.getPosition());
          });

          // Initialize autocomplete for address search
          autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('address-search'),
            { types: ['address'], componentRestrictions: { country: 'kh' } }
          );

          autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
              return;
            }
            
            map.setCenter(place.geometry.location);
            map.setZoom(17);
            marker.setPosition(place.geometry.location);
            updateAddressFromPlace(place);
          });
        }

        // Update address fields from location
        function updateAddressFromLocation(location) {
          geocoder.geocode({ location: location }, function(results, status) {
            if (status === 'OK' && results[0]) {
              updateAddressFromPlace(results[0]);
            } else {
              // Set coordinates even if geocoding fails
              document.getElementById('delivery-latitude').value = location.lat();
              document.getElementById('delivery-longitude').value = location.lng();
              document.getElementById('coordinates-display').value = 
                location.lat().toFixed(6) + ', ' + location.lng().toFixed(6);
            }
          });
        }

        // Update address fields from place
        function updateAddressFromPlace(place) {
          const addressComponents = place.address_components || [];
          let street = '';
          let city = '';
          let province = '';
          let postalCode = '';

          addressComponents.forEach(component => {
            const types = component.types;
            
            if (types.includes('street_number')) {
              street = component.long_name + ' ';
            }
            if (types.includes('route')) {
              street += component.long_name;
            }
            if (types.includes('locality') || types.includes('administrative_area_level_2')) {
              city = component.long_name;
            }
            if (types.includes('administrative_area_level_1')) {
              province = component.long_name;
            }
            if (types.includes('postal_code')) {
              postalCode = component.long_name;
            }
          });

          document.getElementById('delivery-address-full').value = place.formatted_address || street;
          document.getElementById('delivery-city').value = city;
          document.getElementById('delivery-province').value = province;
          document.getElementById('delivery-postal-code').value = postalCode;
          
          const location = place.geometry.location;
          document.getElementById('delivery-latitude').value = location.lat();
          document.getElementById('delivery-longitude').value = location.lng();
          document.getElementById('coordinates-display').value = 
            location.lat().toFixed(6) + ', ' + location.lng().toFixed(6);
          
          selectedLocation = {
            lat: location.lat(),
            lng: location.lng(),
            address: place.formatted_address || street
          };
        }

        // Use current map location
        function useMapLocation() {
          const position = marker.getPosition();
          updateAddressFromLocation(position);
        }

        // Payment method selection
        function selectPaymentMethod(method) {
          document.querySelectorAll('.payment-method-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          event.currentTarget.classList.add('selected');
          
          document.querySelector(`#payment-${method}`).checked = true;
          
          if (method === 'stripe') {
            document.getElementById('stripe-payment-section').style.display = 'block';
            document.getElementById('khqr-payment-section').style.display = 'none';
          } else if (method === 'khqr') {
            document.getElementById('stripe-payment-section').style.display = 'none';
            document.getElementById('khqr-payment-section').style.display = 'block';
            loadKhqrQrCode();
          }
        }

        // Load KHQR QR Code
        async function loadKhqrQrCode() {
          const orderId = document.getElementById('order-id').value;
          const amount = document.getElementById('amount-cents').value / 100;
          
          try {
            const response = await fetch(`/api/v1/payment/generate-khqr?orderId=${orderId}&amount=${amount}&currency=USD`);
            const data = await response.json();
            
            if (response.ok && data.data && data.data.qrImage) {
              document.getElementById('khqr-qr-image-container').innerHTML = 
                `<img src="${data.data.qrImage}" alt="KHQR Payment QR Code" />`;
            } else {
              document.getElementById('khqr-qr-image-container').innerHTML = 
                '<p class="text-danger">Failed to generate QR code. Please try again.</p>';
            }
          } catch (error) {
            console.error('Error loading KHQR:', error);
            document.getElementById('khqr-qr-image-container').innerHTML = 
              '<p class="text-danger">Error loading QR code. Please try again.</p>';
          }
        }

        // Initialize map when page loads
        window.addEventListener('load', function() {
          initMap();
        });

        // Stripe card element
        const cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': {
                color: '#aab7c4',
              },
            },
            invalid: {
              color: '#9e2146',
            },
          },
        });
        
        cardElement.mount('#card-element');
        
        // Handle real-time validation errors from the card Element
        cardElement.on('change', function(event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
        
        // Handle Stripe form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          
          // Validate delivery address
          if (!validateDeliveryAddress()) {
            alert('Please fill in all required delivery address fields');
            return;
          }
          
          const submitButton = document.getElementById('submit-button');
          const buttonText = document.getElementById('button-text');
          const spinner = document.getElementById('spinner');
          
          // Disable button and show spinner
          submitButton.disabled = true;
          buttonText.classList.add('d-none');
          spinner.classList.remove('d-none');
          
          // Save delivery address first using delivery service
          try {
            await saveDeliveryAddress();
          } catch (error) {
            // Show error and re-enable button
            const displayError = document.getElementById('card-errors');
            displayError.textContent = 'Failed to save delivery address: ' + error.message;
            submitButton.disabled = false;
            buttonText.classList.remove('d-none');
            spinner.classList.add('d-none');
            return;
          }
          
          const cardholderName = document.getElementById('cardholder-name').value;
          const orderId = document.getElementById('order-id').value;
          const amountCents = document.getElementById('amount-cents').value;
          
          try {
            // Create payment intent on server
            const response = await fetch('/api/v1/payment/create-payment-intent', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                orderId: orderId,
                amountCents: parseInt(amountCents),
                cardholderName: cardholderName
              })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.message || 'Failed to create payment intent');
            }
            
            // Confirm payment with Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(
              data.data.clientSecret,
              {
                payment_method: {
                  card: cardElement,
                  billing_details: {
                    name: cardholderName,
                  },
                },
              }
            );
            
            if (error) {
              // Show error to user
              const displayError = document.getElementById('card-errors');
              displayError.textContent = error.message;
              submitButton.disabled = false;
              buttonText.classList.remove('d-none');
              spinner.classList.add('d-none');
            } else {
              // Payment succeeded
              if (paymentIntent.status === 'succeeded') {
                window.location.href = '/payment-success?orderId=' + orderId + '&paymentIntentId=' + paymentIntent.id;
              }
            }
          } catch (error) {
            console.error('Error:', error);
            const displayError = document.getElementById('card-errors');
            displayError.textContent = error.message || 'An error occurred. Please try again.';
            submitButton.disabled = false;
            buttonText.classList.remove('d-none');
            spinner.classList.add('d-none');
          }
        });

        // Validate delivery address
        function validateDeliveryAddress() {
          const addressFull = document.getElementById('delivery-address-full').value;
          const city = document.getElementById('delivery-city').value;
          const province = document.getElementById('delivery-province').value;
          const lat = document.getElementById('delivery-latitude').value;
          const lng = document.getElementById('delivery-longitude').value;
          
          return addressFull && city && province && lat && lng;
        }

        // Save delivery address to order using delivery service
        async function saveDeliveryAddress() {
          const orderId = document.getElementById('order-id').value;
          const addressData = {
            deliveryStreet: document.getElementById('delivery-address-full').value,
            deliveryCity: document.getElementById('delivery-city').value,
            deliveryProvince: document.getElementById('delivery-province').value,
            deliveryPostalCode: document.getElementById('delivery-postal-code').value,
            deliveryLatitude: parseFloat(document.getElementById('delivery-latitude').value),
            deliveryLongitude: parseFloat(document.getElementById('delivery-longitude').value),
            deliveryAddressFull: document.getElementById('delivery-address-full').value
          };

          try {
            const response = await fetch(`/api/v1/delivery/address/${orderId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(addressData)
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              console.error('Failed to save delivery address:', errorData.message);
              throw new Error(errorData.message || 'Failed to save delivery address');
            }
            
            const result = await response.json();
            return true;
          } catch (error) {
            console.error('Error saving delivery address:', error);
            throw error;
          }
        }

        // Handle KHQR payment verification
        document.getElementById('verify-khqr-payment').addEventListener('click', async function() {
          if (!validateDeliveryAddress()) {
            alert('Please fill in all required delivery address fields');
            return;
          }

          try {
            await saveDeliveryAddress();
          } catch (error) {
            alert('Failed to save delivery address: ' + error.message);
            return;
          }
          
          const orderId = document.getElementById('order-id').value;
          const amount = document.getElementById('amount-cents').value / 100;
          
          // Redirect to payment verification page
          window.location.href = `/payment-verify-khqr?orderId=${orderId}&amount=${amount}`;
        });
      </script>
    </th:block>
  </body>
</html>
