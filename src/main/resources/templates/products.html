<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/tables.css" />
      <style>
        /* Clean Product Table Styles */
        .product-table {
          background: var(--white);
          border-radius: var(--border-radius-md);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          overflow: hidden;
        }
        
        .product-table table {
          margin-bottom: 0;
        }
        
        .product-table thead {
          background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
          color: var(--white);
        }
        
        .product-table thead th {
          padding: 1rem 1.25rem;
          font-weight: 600;
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border: none;
          white-space: nowrap;
        }
        
        .product-table tbody tr {
          border-bottom: 1px solid #e9ecef;
          transition: background-color 0.15s ease;
        }
        
        .product-table tbody tr:hover {
          background-color: #f8f9fa;
        }
        
        .product-table tbody tr:last-child {
          border-bottom: none;
        }
        
        .product-table tbody td {
          padding: 1rem 1.25rem;
          vertical-align: middle;
          font-size: 0.9rem;
        }
        
        .product-table .badge {
          font-size: 0.75rem;
          padding: 0.35rem 0.65rem;
          font-weight: 500;
        }
        
        .product-table .btn-group-sm .btn {
          padding: 0.25rem 0.5rem;
          font-size: 0.875rem;
        }
      </style>
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle ?: 'Products Management'}">Products Management</title>
  </head>
  <body>
  <th:block th:fragment="main">
  <div class="main-content">
    <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-box-seam'"></div>

    <div class="container-fluid px-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div></div>
        <a th:href="@{/views/products/create}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Create New Product
        </a>
      </div>

      <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> <span th:text="${param.success[0]}">Success</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      
      <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle"></i> <span th:text="${param.error[0]}">Error</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div class="filter-section">
        <h6 class="mb-3"><i class="bi bi-funnel"></i> Filter & Search</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Search products..." id="searchInput" />
          </div>
          <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
              <option value="">All Categories</option>
              <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
            </select>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="ACTIVE">Active</option>
              <option value="INACTIVE">Inactive</option>
            </select>
          </div>
        </div>
      </div>

      <div th:if="${#lists.isEmpty(products)}" class="card mt-4">
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h5>No Products Found</h5>
          <p>There are no products available at the moment.</p>
        </div>
      </div>

      <div th:unless="${#lists.isEmpty(products)}" class="product-table">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead>
              <tr>
                <th style="width: 60px;"><i class="bi bi-hash"></i> ID</th>
                <th><i class="bi bi-image"></i> Image</th>
                <th><i class="bi bi-bag"></i> Product Name</th>
                <th><i class="bi bi-tag"></i> Brand</th>
                <th style="width: 120px;"><i class="bi bi-currency-dollar"></i> Price</th>
                <th style="width: 120px;"><i class="bi bi-box"></i> Inventory</th>
                <th style="width: 100px;"><i class="bi bi-toggles"></i> Status</th>
                <th style="width: 80px;"><i class="bi bi-graph-up"></i> Orders</th>
                <th style="width: 140px;"><i class="bi bi-gear"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="product : ${products}">
                <td class="text-muted fw-semibold" th:text="${product.id}">1</td>
                <td>
                  <div th:if="${product.images != null and !product.images.isEmpty()}">
                    <img th:src="${product.images[0].downloadUrl}" 
                         alt="Product image" 
                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer;"
                         th:data-image-url="${product.images[0].downloadUrl}"
                         onclick="window.open(this.getAttribute('data-image-url'), '_blank')"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <span style="display: none; color: #6c757d; font-size: 0.875rem;">No image</span>
                    <small class="text-muted d-block" style="font-size: 0.75rem;" th:text="${#lists.size(product.images)} + ' image(s)'"></small>
                  </div>
                  <span th:if="${product.images == null or product.images.isEmpty()}" class="text-muted" style="font-size: 0.875rem;">-</span>
                </td>
                <td>
                  <div class="fw-semibold" th:text="${product.name}">Product Name</div>
                  <small class="text-muted" th:if="${product.productType}" th:text="${product.productType}">Type</small>
                </td>
                <td>
                  <span class="text-dark" th:text="${product.brand}">Brand</span>
                </td>
                <td>
                  <span class="fw-bold price-badge text-success" th:text="'$' + ${#numbers.formatDecimal(product.price, 1, 2)}">$0.00</span>
                </td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <span class="fw-semibold" th:text="${product.inventory}">0</span>
                    <i class="bi bi-box text-success" th:if="${product.inventory > 0}" title="In Stock"></i>
                    <i class="bi bi-exclamation-circle text-danger" th:if="${product.inventory == 0}" title="Out of Stock"></i>
                  </div>
                </td>
                <td>
                  <span th:if="${product.status == 'ACTIVE'}" class="status-badge-active">
                    <i class="bi bi-check-circle-fill"></i> Active
                  </span>
                  <span th:if="${product.status != 'ACTIVE'}" class="status-badge-inactive" th:text="${product.status}">Inactive</span>
                </td>
                <td class="text-center">
                  <span class="text-muted" th:text="${product.totalOrders}">0</span>
                </td>
                <td>
                  <div class="table-actions">
                    <a
                      th:href="'/view/products/' + ${product.id}"
                      class="btn-action"
                      title="View"
                    >
                      <i class="bi bi-eye"></i>
                    </a>
                    <a
                      th:href="'/views/products/' + ${product.id} + '/edit'"
                      class="btn-action"
                      title="Edit"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button 
                      type="button"
                      class="btn-action"
                      title="Delete"
                      onclick="deleteProduct([[${product.id}]], '[[${product.name}]]')"
                    >
                      <i class="bi bi-trash"></i> 
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div th:if="${totalPages > 1}" th:replace="~{components/pagination :: pagination('/views/products', ${currentPage}, ${totalPages}, ${hasNext}, ${hasPrev})}"></div>
      </div>

      <div class="mt-4 text-center mb-5">
        <p class="text-muted" th:text="'Total Products: ' + ${products?.size() ?: 0}">Total: 0</p>
      </div>
    </div>
  </div>
  </th:block>
  <th:block th:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      function deleteProduct(productId, productName) {
        if (confirm('Are you sure you want to delete product "' + productName + '"? This action cannot be undone.')) {
          if (typeof showToast === 'function') {
            showToast('Deleting product...', 'info');
          }
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/views/products/' + productId + '/delete';
          
          // Add CSRF token if available
          const csrfToken = document.querySelector('meta[name="_csrf"]');
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
          if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = csrfHeader ? csrfHeader.getAttribute('content') : '_csrf';
            csrfInput.value = csrfToken.getAttribute('content') || csrfToken.content;
            form.appendChild(csrfInput);
          }
          
          document.body.appendChild(form);
          form.submit();
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.addEventListener("keyup", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll(".product-table tbody tr");
            rows.forEach((row) => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(searchTerm) ? "" : "none";
            });
          });
        }

        const categoryFilter = document.getElementById("categoryFilter");
        if (categoryFilter) {
          categoryFilter.addEventListener("change", function (e) {
            // Filter applied
          });
        }

        const statusFilter = document.getElementById("statusFilter");
        if (statusFilter) {
          statusFilter.addEventListener("change", function (e) {
            // Filter applied
          });
        }
      });
    </script>
  </th:block>
</html>
