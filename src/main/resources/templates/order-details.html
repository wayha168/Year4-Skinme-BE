<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/details.css" />
      <link rel="stylesheet" href="/css/badges.css" />
      <link rel="stylesheet" href="/css/tables.css" />
      <style>
        .order-details-table { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .order-details-table table { margin-bottom: 0; }
        .order-details-table thead { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; }
        .order-details-table thead th { padding: 0.75rem 1rem; font-weight: 600; font-size: 0.875rem; border: none; }
        .order-details-table tbody td { padding: 0.75rem 1rem; vertical-align: middle; }
        .order-summary-row { background: #f8f9fa; font-weight: 600; }
        .delivery-row { background: #e8f5e9; }
        .no-print { }
        @media print {
          .no-print { display: none !important; }
          .print-only { display: block !important; }
          body * { visibility: hidden; }
          .app-content, .app-content * { visibility: visible; }
          .app-content { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; }
          .app-sidebar, .app-sidebar *, #toastContainer, #msgLoggingOut { display: none !important; }
          .main-content { padding: 0 !important; }
          .order-details-table thead { background: #2c3e50 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .order-details-table table { border: 1px solid #dee2e6; }
          .order-details-table th, .order-details-table td { border: 1px solid #dee2e6; }
          .card { border: 1px solid #dee2e6; box-shadow: none !important; }
          .delivery-row { background: #f0f8f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
      </style>
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle != null ? pageTitle : 'Order Details'}">Order Details</title>
  </head>
  <body>
    <th:block th:fragment="main">
    <main class="main-content">
      <div class="no-print" th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-bag-check'"></div>
      <div class="print-only invoice-header" style="display: none; margin-bottom: 1rem; padding: 0 1rem;">
        <h2 class="mb-0">Order Invoice</h2>
        <p class="text-muted mb-0 small" th:if="${order}" th:text="${'Order #' + order.orderId}">Order #</p>
      </div>

      <div class="container-fluid px-4 mb-2 no-print">
        <a th:href="@{/views/orders}" class="btn btn-light btn-sm"><i class="bi bi-arrow-left"></i> Back to Orders</a>
      </div>

      <div class="container-fluid px-4 mb-5" th:if="${order}" id="orderDetailsContent" th:data-order-id="${order.orderId}">
        <h4 class="mb-3" th:text="${'Order #' + order.orderId}">Order #</h4>

        <!-- 1. Order items list (table) -->
        <div class="order-details-table mb-4">
          <div class="table-responsive">
            <table class="table table-hover mb-0 invoice-table">
              <thead>
                <tr>
                  <th class="text-center" style="width: 3rem;">#</th>
                  <th>Product</th>
                  <th>Brand</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Unit Price</th>
                  <th class="text-end">Line Total</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="item, iterStat : ${order.orderItems}" th:with="unitPrice=${item.price != null ? item.price : 0}, lineTotal=${item.price != null ? item.price.doubleValue() * item.quantity : 0}">
                  <td class="text-center" th:text="${iterStat.count}">1</td>
                  <td><strong th:text="${item.product != null and item.product.name != null ? item.product.name : 'N/A'}">Product</strong></td>
                  <td th:text="${item.product != null and item.product.brand != null ? item.product.brand : 'N/A'}">Brand</td>
                  <td class="text-center" th:text="${item.quantity}">1</td>
                  <td class="text-end" th:text="'$' + ${#numbers.formatDecimal(unitPrice, 1, 2)}">$0.00</td>
                  <td class="text-end"><strong th:text="'$' + ${#numbers.formatDecimal(lineTotal, 1, 2)}">$0.00</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 2. Summary: Date, Total, Discount, Status (one block) -->
        <div class="card mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6 col-lg-3">
                <span class="text-muted d-block small">Order Date</span>
                <span class="fw-semibold" th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'MM/dd/yyyy') : 'N/A'}">Date</span>
              </div>
              <div class="col-md-6 col-lg-3">
                <span class="text-muted d-block small">Total Amount</span>
                <span class="fw-bold text-success" style="font-size: 1.1rem;" th:text="'$' + ${#numbers.formatDecimal(order.orderTotalAmount != null ? order.orderTotalAmount : 0, 1, 2)}">$0.00</span>
              </div>
              <div class="col-md-6 col-lg-3">
                <span class="text-muted d-block small">Discount</span>
                <span class="fw-semibold" th:text="'None'">None</span>
              </div>
              <div class="col-md-6 col-lg-3">
                <span class="text-muted d-block small">Status</span>
                <span th:if="${order.orderStatus != null and (order.orderStatus.toString() == 'COMPLETED' or order.orderStatus.toString() == 'DELIVERED')}" class="status-badge-active"><i class="bi bi-check-circle-fill"></i> <span th:text="${order.orderStatus}">COMPLETED</span></span>
                <span th:if="${order.orderStatus == null or (order.orderStatus.toString() != 'COMPLETED' and order.orderStatus.toString() != 'DELIVERED')}" class="status-badge-inactive" th:text="${order.orderStatus != null ? order.orderStatus : 'PENDING'}">PENDING</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. Delivery: one row -->
        <div class="card mb-4 delivery-row">
          <div class="card-body py-3">
            <h6 class="mb-2"><i class="bi bi-truck"></i> Delivery</h6>
            <div th:if="${order.trackingNumber != null and !order.trackingNumber.isEmpty()}" class="mb-1">
              <span class="text-muted">Tracking:</span> <span class="fw-semibold" th:text="${order.trackingNumber}">-</span>
            </div>
            <div th:if="${order.deliveryAddressFull != null and !order.deliveryAddressFull.isEmpty()}" class="mb-1" th:text="${order.deliveryAddressFull}">Address</div>
            <div th:if="${order.deliveryStreet != null and !order.deliveryStreet.isEmpty()}"><span th:text="${order.deliveryStreet + ', ' + (order.deliveryCity != null ? order.deliveryCity : '') + ', ' + (order.deliveryProvince != null ? order.deliveryProvince : '')}">Street, City, Province</span></div>
            <div th:if="${order.deliveryLatitude != null and order.deliveryLongitude != null}">
              <a th:href="${'https://www.google.com/maps?q=' + order.deliveryLatitude + ',' + order.deliveryLongitude}" target="_blank" class="btn btn-sm btn-outline-primary no-print"><i class="bi bi-map"></i> View on Map</a>
            </div>
            <div th:if="${order.shippedAt != null}" class="small mt-1">Shipped: <span th:text="${#temporals.format(order.shippedAt, 'MM/dd/yyyy HH:mm')}">-</span></div>
            <div th:if="${order.deliveredAt != null}" class="small">Delivered: <span th:text="${#temporals.format(order.deliveredAt, 'MM/dd/yyyy HH:mm')}">-</span></div>
            <p th:if="${(order.deliveryAddressFull == null or order.deliveryAddressFull.isEmpty()) and (order.deliveryStreet == null or order.deliveryStreet.isEmpty())}" class="text-muted mb-0 small">No delivery address set.</p>
          </div>
        </div>

        <!-- 4. Download & Print -->
        <div class="card no-print">
          <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-primary" id="btnDownloadInvoice">
                <i class="bi bi-download"></i> Download Invoice
              </button>
              <button type="button" class="btn btn-outline-primary" id="btnPrintOrder">
                <i class="bi bi-printer"></i> Print Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid px-4 mb-5" th:unless="${order}">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i> <span th:text="${error != null ? error : 'Order not found'}">Order not found</span>
        </div>
      </div>
    </main>
    </th:block>
    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
          var btnPrint = document.getElementById('btnPrintOrder');
          if (btnPrint) btnPrint.addEventListener('click', function() { window.print(); });

          var btnDownload = document.getElementById('btnDownloadInvoice');
          if (btnDownload) {
            btnDownload.addEventListener('click', function() {
              var el = document.getElementById('orderDetailsContent');
              var orderId = el && el.getAttribute('data-order-id') ? el.getAttribute('data-order-id') : 'invoice';
              var invoiceStyles = '<style>body{font-family:system-ui,-apple-system,sans-serif;margin:1.5rem;color:#333;}.no-print{display:none!important}.invoice-title{margin-bottom:1rem;}.invoice-title h2{margin:0;font-size:1.5rem;}.invoice-table,.order-details-table table{border-collapse:collapse;width:100%;margin:1rem 0;}.invoice-table th,.invoice-table td,.order-details-table th,.order-details-table td{border:1px solid #dee2e6;padding:0.5rem 0.75rem;text-align:left;}.invoice-table th,.order-details-table thead th{background:#2c3e50;color:#fff;}.text-center{text-align:center}.text-end{text-align:right}.card{border:1px solid #dee2e6;border-radius:8px;padding:1rem;margin:1rem 0;}.delivery-row{background:#f0f8f0;}</style>';
              var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Order #' + orderId + ' - Invoice</title>' + invoiceStyles + '</head><body><div class="invoice-title"><h2>Order Invoice</h2><p style="margin:0;color:#6c757d;font-size:0.875rem">Order #' + orderId + '</p></div>' + (el ? el.outerHTML : '') + '</body></html>';
              var blob = new Blob([html], { type: 'text/html;charset=utf-8' });
              var url = URL.createObjectURL(blob);
              var link = document.createElement('a');
              link.href = url;
              link.download = 'order-' + orderId + '.html';
              link.style.display = 'none';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
            });
          }
        });
      </script>
    </th:block>
</html>
