<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/details.css" />
      <link rel="stylesheet" href="/css/badges.css" />
      <link rel="stylesheet" href="/css/tables.css" />
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle ?: 'User Details'}">User Details</title>
  </head>
  <body>
    <th:block th:fragment="main">
    <main class="main-content">
      <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-person-circle'"></div>
      <div class="container-fluid px-4 mb-2">
        <a th:href="@{/views/users}" class="btn btn-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back
        </a>
      </div>
      
      <div th:if="${param.success}" class="container-fluid px-4 mb-2">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle"></i> <span th:text="${param.success[0]}">Success</span>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
      
      <div th:if="${param.error}" class="container-fluid px-4 mb-2">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle"></i> <span th:text="${param.error[0]}">Error</span>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>

      <div class="container-fluid px-4 mb-5" th:if="${user}">
        <div class="row">
          <div class="col-lg-8">
            <div class="card detail-card">
              <div class="card-body p-4">
                <h3 class="mb-3">
                  <span th:if="${user.firstName != null}" th:text="${user.firstName}">First</span>
                  <span th:if="${user.firstName != null and user.lastName != null}" th:text="' '"> </span>
                  <span th:if="${user.lastName != null}" th:text="${user.lastName}">Last</span>
                  <span th:if="${user.firstName == null and user.lastName == null}" th:text="'User'">User</span>
                </h3>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-hash"></i> User ID</span>
                  <span class="info-value" th:text="${user.id}">ID</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-envelope"></i> Email</span>
                  <span class="info-value" th:text="${user.email}">email@example.com</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-shield-check"></i> Roles</span>
                  <span class="info-value">
                    <span th:each="role : ${user.roles}" class="badge bg-secondary me-1">
                      <span th:text="${role.name}">ROLE</span>
                      <form th:action="@{/views/users/{id}/remove-role(id=${user.id})}" method="POST" style="display: inline;" th:if="${allRoles != null and allRoles.size() > 1}">
                        <input type="hidden" name="roleName" th:value="${role.name}"/>
                        <button type="submit" class="btn btn-sm p-0 ms-1 text-white" style="background: none; border: none; font-size: 0.7em;" onclick="return confirm('Remove this role?')">
                          <i class="bi bi-x-circle"></i>
                        </button>
                      </form>
                    </span>
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-calendar"></i> Registration Date</span>
                  <span class="info-value" th:text="${user.registrationDate != null ? #temporals.format(user.registrationDate, 'MM/dd/yyyy HH:mm') : 'N/A'}">Date</span>
                </div>
                <div class="info-row" th:if="${user.lastLogin != null}">
                  <span class="info-label"><i class="bi bi-clock-history"></i> Last Login</span>
                  <span class="info-value" th:text="${#temporals.format(user.lastLogin, 'MM/dd/yyyy HH:mm')}">Date</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-circle-fill"></i> Status</span>
                  <span th:class="'table-tag table-tag-' + (${user.enabled} ? 'active' : 'inactive')" th:text="${user.enabled ? 'Active' : 'Inactive'}">Active</span>
                </div>
                <div class="info-row border-0">
                  <span class="info-label"><i class="bi bi-circle"></i> Online Status</span>
                  <span th:class="'table-tag table-tag-' + (${user.isOnline} ? 'online' : 'offline')" th:text="${user.isOnline ? 'Online' : 'Offline'}">Offline</span>
                </div>
              </div>
            </div>

            <div class="card detail-card mt-4" th:if="${user.orders != null and !user.orders.isEmpty()}">
              <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                <h5 class="mb-0"><i class="bi bi-bag"></i> User Orders</h5>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead>
                      <tr>
                        <th><i class="bi bi-hash"></i> Order ID</th>
                        <th><i class="bi bi-calendar"></i> Date</th>
                        <th><i class="bi bi-currency-dollar"></i> Amount</th>
                        <th><i class="bi bi-tags"></i> Status</th>
                        <th><i class="bi bi-gear"></i> Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="order : ${user.orders}">
                        <td><strong th:text="'#' + ${order.orderId}">Order ID</strong></td>
                        <td th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'MM/dd/yyyy') : 'N/A'}">Date</td>
                        <td th:text="'$' + ${#numbers.formatDecimal(order.orderTotalAmount != null ? order.orderTotalAmount : 0, 1, 2)}">$0.00</td>
                        <td>
                          <span th:if="${order.orderStatus?.toString() == 'COMPLETED' || order.orderStatus?.toString() == 'DELIVERED'}" class="status-badge-active">
                            <i class="bi bi-check-circle-fill"></i> <span th:text="${order.orderStatus}">COMPLETED</span>
                          </span>
                          <span th:if="${order.orderStatus?.toString() != 'COMPLETED' && order.orderStatus?.toString() != 'DELIVERED'}" class="status-badge-inactive" th:text="${order.orderStatus != null ? order.orderStatus : 'PENDING'}">PENDING</span>
                        </td>
                        <td>
                          <div class="table-actions">
                            <button class="btn-action" th:attr="onclick='viewOrderDetails(' + ${order.orderId} + ')'" title="View">
                              <i class="bi bi-eye"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card detail-card">
              <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> User Actions</h5>
              </div>
              <div class="card-body">
                <a th:href="@{/views/users/{id}/edit(id=${user.id})}" class="btn btn-primary w-100 mb-2">
                  <i class="bi bi-pencil"></i> Edit User
                </a>
                <form th:action="@{/views/users/{id}/delete(id=${user.id})}" method="POST" style="margin-bottom: 1rem;">
                  <button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                    <i class="bi bi-trash"></i> Delete User
                  </button>
                </form>
                
                <hr>
                
                <h6 class="mb-3"><i class="bi bi-shield-check"></i> Assign Role</h6>
                <form th:action="@{/views/users/{id}/assign-role(id=${user.id})}" method="POST">
                  <div class="mb-2">
                    <select name="roleName" class="form-select" required>
                      <option value="">Select a role...</option>
                      <option th:each="role : ${allRoles}" 
                              th:value="${role.name}" 
                              th:text="${role.name}"
                              th:disabled="${user.roles != null and user.roles.contains(role)}">
                        Role
                      </option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-plus-circle"></i> Assign Role
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="container-fluid px-4 mb-5" th:unless="${user}">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-circle"></i> <span th:text="${error ?: 'User not found'}"></span>
        </div>
      </div>
    </main>
    </th:block>
    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        function viewOrderDetails(orderId) {
          showToast('Loading order details...', 'info');
          window.location.href = '/view/orders/' + orderId;
        }
      </script>
    </th:block>
</html>
