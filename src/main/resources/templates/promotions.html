<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/details.css" />
      <link rel="stylesheet" href="/css/alerts.css" />
      <link rel="stylesheet" href="/css/tables.css" />
      <style>
        .promotion-table {
          background: var(--white);
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          overflow: hidden;
        }
        .promotion-table thead {
          background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
          color: var(--white);
        }
        .promotion-table thead th {
          padding: 1rem 1.25rem;
          font-weight: 600;
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border: none;
          white-space: nowrap;
        }
        .promotion-table tbody tr {
          border-bottom: 1px solid #e9ecef;
          transition: background-color 0.15s ease;
        }
        .promotion-table tbody tr:hover { background-color: #f8f9fa; }
        .promotion-table tbody tr:last-child { border-bottom: none; }
        .promotion-table tbody td {
          padding: 1rem 1.25rem;
          vertical-align: middle;
          font-size: 0.9rem;
        }
        .promotion-table .promo-title { font-weight: 600; color: #111827; }
        .promotion-table .promo-muted { font-size: 0.8125rem; color: #6b7280; }
        .promotion-table .price-original { text-decoration: line-through; color: #6b7280; font-size: 0.875rem; }
        .promotion-table .price-sale { font-weight: 600; color: #16a34a; }
      </style>
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle ?: 'Promotion Management'}">Promotion Management</title>
  </head>
  <body>
    <th:block th:fragment="main">
      <div class="main-content">
        <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-tag', pageTitle='Promotion Management'"></div>

        <div class="container-fluid px-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" style="font-weight: 700; color: #111827;">
              <i class="bi bi-tag"></i> Promotions
            </h2>
            <a th:href="@{/views/promotions/create}" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Create Promotion
            </a>
          </div>

          <div th:if="${param.success}" class="alert alert-box alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${param.success[0]}">Success</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          <div th:if="${param.error}" class="alert alert-box alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i> <span th:text="${param.error[0]}">Error</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>

          <div th:if="${#lists.isEmpty(promotions)}" class="card mt-4">
            <div class="empty-state">
              <i class="bi bi-inbox"></i>
              <h5>No Promotions Found</h5>
              <p>No promotions at the moment. <a th:href="@{/views/promotions/create}">Create your first promotion</a>.</p>
            </div>
          </div>

          <div th:unless="${#lists.isEmpty(promotions)}" class="promotion-table">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead>
                  <tr>
                    <th style="width: 60px;"><i class="bi bi-hash"></i> ID</th>
                    <th><i class="bi bi-tag"></i> Title</th>
                    <th><i class="bi bi-box"></i> Product</th>
                    <th style="width: 90px;"><i class="bi bi-percent"></i> Discount</th>
                    <th style="width: 120px;"><i class="bi bi-calendar-check"></i> Start</th>
                    <th style="width: 120px;"><i class="bi bi-calendar-x"></i> Deadline</th>
                    <th style="width: 140px;"><i class="bi bi-currency-dollar"></i> Prices</th>
                    <th style="width: 90px;"><i class="bi bi-image"></i> Images</th>
                    <th style="width: 100px;"><i class="bi bi-toggles"></i> Status</th>
                    <th style="width: 120px;"><i class="bi bi-gear"></i> Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="promotion : ${promotions}">
                    <td class="text-muted fw-semibold" th:text="${promotion.id}">1</td>
                    <td>
                      <div class="promo-title" th:text="${promotion.title}">Title</div>
                      <div class="promo-muted" th:if="${promotion.description}" th:text="${#strings.abbreviate(promotion.description, 45)}" th:title="${promotion.description}">Description</div>
                    </td>
                    <td>
                      <div class="fw-semibold text-dark" th:text="${promotion.productName}">Product</div>
                      <div class="promo-muted" th:text="'ID: ' + ${promotion.productId}">ID</div>
                    </td>
                    <td>
                      <span class="fw-semibold text-dark" th:text="${#numbers.formatDecimal(promotion.discountPercentage, 1, 2)} + '%'">0%</span>
                    </td>
                    <td>
                      <div class="text-dark" th:text="${#temporals.format(promotion.startDate, 'MMM dd, yyyy')}">Start</div>
                      <div class="promo-muted" th:text="${#temporals.format(promotion.startDate, 'HH:mm')}">Time</div>
                    </td>
                    <td>
                      <div class="text-dark" th:text="${#temporals.format(promotion.deadline, 'MMM dd, yyyy')}">Deadline</div>
                      <div class="promo-muted text-danger" th:if="${promotion.expired}">Expired</div>
                      <div class="promo-muted text-success" th:if="${promotion.currentlyActive}">Active now</div>
                    </td>
                    <td>
                      <div class="price-original" th:text="'$' + ${#numbers.formatDecimal(promotion.originalPrice, 1, 2)}">$0.00</div>
                      <div class="price-sale" th:text="'$' + ${#numbers.formatDecimal(promotion.discountedPrice, 1, 2)}">$0.00</div>
                    </td>
                    <td>
                      <div th:if="${promotion.images != null and !promotion.images.isEmpty()}">
                        <img th:src="${promotion.images[0].downloadUrl}"
                             alt="Promo" style="width: 44px; height: 44px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; cursor: pointer;"
                             th:attr="data-image-url=${promotion.images[0].downloadUrl}"
                             onclick="window.open(this.getAttribute('data-image-url'), '_blank')"
                             onerror="this.style.display='none'"
                             role="button" />
                        <div class="promo-muted mt-1" th:text="${#lists.size(promotion.images)} + ' image(s)'">0 image(s)</div>
                      </div>
                      <span th:if="${promotion.images == null or promotion.images.isEmpty()}" class="promo-muted">â€”</span>
                    </td>
                    <td>
                      <span th:if="${promotion.active}" class="status-badge-active"><i class="bi bi-check-circle-fill"></i> Active</span>
                      <span th:unless="${promotion.active}" class="status-badge-inactive">Inactive</span>
                    </td>
                    <td>
                      <div class="table-actions">
                        <button type="button" class="btn-action" th:attr="onclick='viewPromotion(' + ${promotion.id} + ')'" title="View"><i class="bi bi-eye"></i></button>
                        <button type="button" class="btn-action" th:attr="onclick='editPromotion(' + ${promotion.id} + ')'" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button type="button" class="btn-action" th:attr="onclick='deletePromotion(' + ${promotion.id} + ')'" title="Delete"><i class="bi bi-trash"></i></button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div th:if="${totalPages > 1}" class="mt-4 d-flex justify-content-between align-items-center">
              <a th:if="${hasPrev}" th:href="@{/views/promotions(page=${currentPage - 1})}" class="btn btn-outline-primary btn-sm"><i class="bi bi-chevron-left"></i> Previous</a>
              <span class="text-muted">Page <span th:text="${currentPage + 1}">1</span> of <span th:text="${totalPages}">1</span></span>
              <a th:if="${hasNext}" th:href="@{/views/promotions(page=${currentPage + 1})}" class="btn btn-outline-primary btn-sm">Next <i class="bi bi-chevron-right"></i></a>
            </div>
          </div>
        </div>
      </div>
    </th:block>

    <th:block th:fragment="script">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script th:inline="javascript">
        const API_PREFIX = /*[[${api.prefix}]]*/ '/api/v1';

        // View promotion details
        function viewPromotion(id) {
          if (typeof showToast === 'function') {
            showToast('Loading promotion details...', 'info');
          }
          window.location.href = '/views/promotions/' + id;
        }
        
        // Edit promotion - navigate to create page with edit parameter
        function editPromotion(id) {
          if (typeof showToast === 'function') {
            showToast('Loading promotion for editing...', 'info');
          }
          window.location.href = '/views/promotions/create?id=' + id;
        }

        // Delete promotion
        async function deletePromotion(id) {
          if (!confirm('Are you sure you want to delete this promotion? This action cannot be undone.')) {
            return;
          }
          
          if (typeof showToast === 'function') {
            showToast('Deleting promotion...', 'info');
          }
          
          try {
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
            const headers = {
              'Content-Type': 'application/json'
            };
            
            if (csrfToken && csrfHeader) {
              headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content') || csrfToken.content;
            }
            
            const response = await fetch(`${API_PREFIX}/promotions/${id}`, {
              method: 'DELETE',
              headers: headers
            });
            
            const result = await response.json();
            
            if (response.ok) {
              if (typeof showToast === 'function') {
                showToast('Promotion deleted successfully', 'success');
              }
              setTimeout(() => location.reload(), 1000);
            } else {
              if (typeof showToast === 'function') {
                showToast('Failed to delete promotion: ' + (result.message || 'Unknown error'), 'error');
              }
            }
          } catch (error) {
            console.error('Error deleting promotion:', error);
            if (typeof showToast === 'function') {
              showToast('Error deleting promotion: ' + error.message, 'error');
            }
          }
        }
      </script>
    </th:block>
  </body>
</html>
