<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{app :: layout(~{::main}, ~{::style}, ~{::script})}"
>
  <head>
    <th:block th:fragment="style">
      <link rel="stylesheet" href="/css/common.css" />
      <link rel="stylesheet" href="/css/details.css" />
      <link rel="stylesheet" href="/css/alerts.css" />
      <link rel="stylesheet" href="/css/tables.css" />
    </th:block>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${pageTitle ?: 'Categories Management'}">Categories Management</title>
  </head>
  <body>
  <th:block th:fragment="main">
  <div class="main-content">
    <div th:replace="~{components/page-header :: page-header}" th:with="pageIcon='bi-tags'"></div>

    <div class="container-fluid px-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0" style="font-weight: 700; color: #111827;">
          <i class="bi bi-card-checklist"></i> Categories
        </h2>
        <a th:href="@{/views/categories/create}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add New Category
        </a>
      </div>

      <div th:if="${param.success}" class="alert alert-box alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> <span th:text="${param.success[0]}">Success</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      <div th:if="${param.error}" class="alert alert-box alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle"></i> <span th:text="${param.error[0]}">Error</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      <div th:if="${error}" class="alert alert-box alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-circle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div class="filter-section">
        <h6 class="mb-3"><i class="bi bi-funnel"></i> Filter & Search</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Search by name or description..." id="categorySearchInput" />
          </div>
        </div>
      </div>

      <div th:if="${#lists.isEmpty(categories)}" class="card mt-4">
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h5>No Categories Found</h5>
          <p>There are no categories available at the moment.</p>
        </div>
      </div>

      <div th:unless="${#lists.isEmpty(categories)}" class="data-table mt-4">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th><i class="bi bi-tag"></i> Name</th>
                <th><i class="bi bi-text-paragraph"></i> Description</th>
                <th><i class="bi bi-image"></i> Image</th>
                <th><i class="bi bi-link-45deg"></i> Link</th>
                <th style="width: 100px;"><i class="bi bi-box-seam"></i> Products</th>
                <th style="width: 120px;"><i class="bi bi-gear"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="category : ${categories}">
                <td class="text-muted fw-semibold" th:text="${category.id}">1</td>
                <td>
                  <div class="fw-semibold text-dark" th:text="${category.name}">Category Name</div>
                </td>
                <td>
                  <div class="text-muted" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                       th:text="${category.description != null and !category.description.isEmpty() ? #strings.abbreviate(category.description, 50) : '-'}" 
                       th:title="${category.description != null ? category.description : ''}">-</div>
                </td>
                <td>
                  <div th:if="${category.image != null and !category.image.isEmpty()}">
                    <img th:src="${category.image}" 
                         alt="Category image" 
                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd; cursor: pointer;"
                         th:data-image-url="${category.image}"
                         onclick="window.open(this.getAttribute('data-image-url'), '_blank')"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <span style="display: none; color: #6c757d; font-size: 0.875rem;">No image</span>
                  </div>
                  <span th:if="${category.image == null or category.image.isEmpty()}" class="text-muted" style="font-size: 0.875rem;">-</span>
                </td>
                <td>
                  <a th:if="${category.link != null and !category.link.isEmpty()}" 
                     th:href="${category.link}" 
                     target="_blank"
                     class="text-primary text-decoration-none"
                     th:text="${#strings.abbreviate(category.link, 30)}"
                     th:title="${category.link}">
                    Link
                  </a>
                  <span th:if="${category.link == null or category.link.isEmpty()}" class="text-muted">-</span>
                </td>
                <td>
                  <span class="text-muted" th:text="${category.products?.size() ?: 0}">0</span>
                  <small class="text-muted d-block">products</small>
                </td>
                <td>
                  <div class="table-actions">
                    <a
                      th:href="'/view/products/category/' + ${category.id}"
                      class="btn-action"
                      title="View Products"
                    >
                      <i class="bi bi-eye"></i>
                    </a>
                    <a
                      th:href="'/views/categories/' + ${category.id} + '/edit'"
                      class="btn-action"
                      title="Edit"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button 
                      type="button"
                      class="btn-action"
                      title="Delete"
                      th:attr="onclick='deleteCategory(' + ${category.id} + ', &quot;' + ${category.name} + '&quot;)'"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div th:if="${totalPages > 1}" th:replace="~{components/pagination :: pagination('/views/categories', ${currentPage}, ${totalPages}, ${hasNext}, ${hasPrev})}"></div>
      </div>
    </div>
  </div>
  </th:block>
  <th:block th:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      function applyCategoryFilters() {
        var searchTerm = (document.getElementById("categorySearchInput") && document.getElementById("categorySearchInput").value) ? document.getElementById("categorySearchInput").value.toLowerCase() : "";
        var rows = document.querySelectorAll(".data-table tbody tr");
        rows.forEach(function(row) {
          var text = row.textContent.toLowerCase();
          row.style.display = !searchTerm || text.indexOf(searchTerm) !== -1 ? "" : "none";
        });
      }
      document.addEventListener("DOMContentLoaded", function() {
        var searchInput = document.getElementById("categorySearchInput");
        if (searchInput) searchInput.addEventListener("keyup", applyCategoryFilters);
      });
      function deleteCategory(categoryId, categoryName) {
        if (confirm('Are you sure you want to delete category "' + categoryName + '"? This action cannot be undone.')) {
          if (typeof showToast === 'function') {
            showToast('Deleting category...', 'info');
          }
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/views/categories/' + categoryId + '/delete';
          
          // Add CSRF token if available
          const csrfToken = document.querySelector('meta[name="_csrf"]');
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
          if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = csrfHeader ? csrfHeader.getAttribute('content') : '_csrf';
            csrfInput.value = csrfToken.getAttribute('content') || csrfToken.content;
            form.appendChild(csrfInput);
          }
          
          document.body.appendChild(form);
          form.submit();
        }
      }
    </script>
  </th:block>
</html>
